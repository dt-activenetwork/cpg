# CPG 精确可达性分析 - Mermaid 图表源码

本文档包含演示文稿中所有 Mermaid 图表的源代码，方便编辑和复用。

---

## 图表清单

| 图表编号 | 名称 | 幻灯片 | 类型 |
|---------|------|--------|------|
| D1 | CPG 四层架构 | 5 | flowchart |
| D2 | 完整流程序列图 | 7 | sequenceDiagram |
| D3 | AST 结构树 | 10 | graph |
| D4 | EOG 构建 (所有分支) | 12 | flowchart |
| D5 | DFG 常量流动 | 13 | flowchart |
| D6 | EOG 剪枝后 | 16 | flowchart |
| D7 | 最终可达图 | 17 | flowchart |
| D8 | 完整流程回顾 | 19 | sequenceDiagram |
| D9 | Scenario 2 DFG | 21 | flowchart |
| D10 | Pass 执行顺序 | 附录 | graph |

---

## D1: CPG 四层架构 (幻灯片 5)

```mermaid
flowchart TD
    Source[源代码] --> AST[Layer 1: AST<br/>抽象语法树]
    AST --> EOG[Layer 2: EOG<br/>执行顺序图]
    AST --> DFG[Layer 3: DFG<br/>数据流图]
    EOG --> Eval[Layer 4: 常量求值]
    DFG --> Eval
    Eval --> Prune[分支剪枝]
    Prune --> Result[精确可达性结果]

    style AST fill:#e1f5ff
    style EOG fill:#ffe1f5
    style DFG fill:#f5ffe1
    style Eval fill:#fff5e1
    style Prune fill:#ff9999
    style Result fill:#99ff99
```

**用途**: 展示 CPG 的整体架构和数据流动

**编辑建议**:
- 可以添加更多层次细节
- 可以调整颜色以匹配品牌色

---

## D2: 完整流程序列图 (幻灯片 7)

```mermaid
sequenceDiagram
    participant S as 源代码
    participant F as 前端解析
    participant A as AST构建
    participant E as EOG构建
    participant D as DFG构建
    participant V as 常量求值
    participant P as 分支剪枝
    participant Q as 查询引擎

    S->>F: Java源文件
    F->>A: Token流
    A->>E: AST节点
    E->>E: 构建控制流边
    E->>D: EOG完成
    D->>D: 追踪数据依赖
    D->>V: DFG完成
    V->>V: ValueEvaluator求值
    V->>P: 条件 = true/false
    P->>P: 标记unreachable边
    P->>Q: 图构建完成
    Q->>Q: 自动过滤不可达边
```

**用途**: 展示从源码到结果的完整流程

**编辑建议**:
- 可以添加更多交互细节
- 可以添加错误处理路径

---

## D3: AST 结构树 (幻灯片 10)

```mermaid
graph TD
    Method[MethodDeclaration:<br/>generateTanpoCal] --> Block[Block]
    Block --> Decl[VariableDeclaration:<br/>tanpoCal = null]
    Block --> If1[IfStatement 1]
    If1 --> Cond1[Condition:<br/>sijiKbn.equals...]
    If1 --> Then1[Then: new TanpoCalTodYak]
    If1 --> Else1[Else: IfStatement 2]
    Else1 --> Cond2[Condition:<br/>sijiKbn.equals...]
    Else1 --> Then2[Then: new TanpoCal2ddTsei]
    Else1 --> Else2[Else: IfStatement 3...]

    style If1 fill:#ffe1e1
    style Else1 fill:#ffe1e1
```

**用途**: 展示 AST 的树形结构

---

## D4: EOG 构建 - 所有分支可达 (幻灯片 12)

```mermaid
flowchart TD
    Start[方法入口] --> Decl[tanpoCal = null]
    Decl --> If1{IfStatement 1:<br/>equals TOJITUYAK?}
    If1 -->|EOG: true| B1[new TanpoCalTodYak]
    If1 -->|EOG: false| If2{IfStatement 2:<br/>equals 2DDTEISEI?}
    If2 -->|EOG: true| B2[new TanpoCal2ddTsei]
    If2 -->|EOG: false| If3{IfStatement 3:<br/>equals 3DDTEISEI?}
    If3 -->|EOG: true| B3[new TanpoCal3ddTsei]
    If3 -->|EOG: false| More[...]

    B1 --> Return[return tanpoCal]
    B2 --> Return
    B3 --> Return
    More --> Return

    style If1 fill:#fff5cc
    style If2 fill:#fff5cc
    style If3 fill:#fff5cc
```

**用途**: 展示 EOG 边的初始状态（所有分支可达）

---

## D5: DFG 常量流动 (幻灯片 13)

```mermaid
flowchart LR
    Const1["常量定义:<br/>TANPO_CAL_I_K_TOJITUYAK<br/>= '01'"] -->|DFG| Ref1["条件1中的引用"]
    Const2["常量定义:<br/>TANPO_CAL_I_K_2DDTEISEI<br/>= '02'"] -->|DFG| Ref2["条件2中的引用"]
    Const3["常量定义:<br/>TANPO_CAL_I_K_3DDTEISEI<br/>= '03'"] -->|DFG| Ref3["条件3中的引用"]

    Param["参数: sijiKbn"] -->|DFG| Cond1["条件1:<br/>sijiKbn.equals..."]
    Param -->|DFG| Cond2["条件2"]
    Param -->|DFG| Cond3["条件3"]

    Ref1 -->|DFG| Cond1
    Ref2 -->|DFG| Cond2
    Ref3 -->|DFG| Cond3

    style Const1 fill:#ccf5ff
    style Const2 fill:#ccf5ff
    style Const3 fill:#ccf5ff
    style Param fill:#ffcccc
```

**用途**: 展示 DFG 如何连接常量定义与条件表达式

**节点说明**:
- 蓝色节点: 常量定义 (编译时已知值)
- 红色节点: 方法参数 (运行时传入)
- DFG 箭头: 数据流依赖关系

---

## D6: EOG 剪枝后 (幻灯片 16)

```mermaid
flowchart TD
    Start[方法入口] --> If1{IfStatement 1}
    If1 -->|true<br/>✅ 可达| B1[new TanpoCalTodYak]
    If1 -.->|false<br/>❌ 不可达| If2{IfStatement 2}
    If2 -.->|true<br/>❌ 不可达| B2[new TanpoCal2ddTsei]
    If2 -.->|false<br/>❌ 不可达| If3[...]

    B1 --> Return[return]

    style B1 fill:#99ff99
    style If2 fill:#cccccc
    style B2 fill:#cccccc
    style If3 fill:#cccccc

    linkStyle 1 stroke:#999,stroke-width:2px,stroke-dasharray: 5 5
    linkStyle 2 stroke:#999,stroke-width:2px,stroke-dasharray: 5 5
    linkStyle 3 stroke:#999,stroke-width:2px,stroke-dasharray: 5 5
```

**用途**: 展示分支剪枝后的 EOG 状态

---

## D7: 最终可达图 (幻灯片 17)

```mermaid
flowchart TD
    Start[方法入口] --> Decl[tanpoCal = null]
    Decl --> If1[IfStatement 1]
    If1 --> B1[new TanpoCalTodYak]
    B1 --> Return[return tanpoCal]

    style Start fill:#99ff99
    style Decl fill:#99ff99
    style If1 fill:#99ff99
    style B1 fill:#99ff99
    style Return fill:#99ff99
```

**用途**: 展示最终的可达节点

---

## D8: 完整流程回顾 (幻灯片 19)

```mermaid
sequenceDiagram
    autonumber
    participant Src as 源代码
    participant AST as AST层
    participant EOG as EOG层
    participant DFG as DFG层
    participant Eval as 求值器
    participant Query as 查询引擎
    participant User as 用户

    Src->>AST: 解析
    AST->>EOG: 构建控制流
    Note over EOG: 所有分支标记为可达
    AST->>DFG: 构建数据流
    Note over DFG: 追踪常量 → 条件
    DFG->>Eval: 求值条件
    Eval->>Eval: "01".equals("01") = true
    Eval->>EOG: 标记 false 分支不可达
    User->>Query: executionPath(start, predicate)
    Query->>Query: 自动过滤不可达边
    Query-->>User: 返回精确路径
```

**用途**: 完整流程的序列图回顾

---

## D9: Scenario 2 DFG (幻灯片 21)

```mermaid
flowchart LR
    Const["常量:<br/>DIL_OUT_F_GAMN<br/>= 'SCREEN'"] -->|DFG| Arg["调用参数:<br/>outputFormat"]
    Arg -->|"DFG 跨方法"| Param["方法参数:<br/>outputFormat"]
    Param -->|DFG| Cond1["条件1:<br/>equals GAMN"]
    Param -->|DFG| Cond2["条件2:<br/>equals CSV"]
    Param -->|DFG| Cond3["条件3:<br/>equals PDF"]

    style Const fill:#ccf5ff
    style Arg fill:#ffffcc
    style Param fill:#ffccff
```

**用途**: 展示跨方法边界的 DFG

**节点说明**:
- 蓝色节点: 常量定义 ("SCREEN")
- 黄色节点: 调用参数 (传递常量)
- 紫色节点: 方法参数 (接收常量)
- "DFG 跨方法": 表示数据流跨越方法边界

---

## D10: Pass 执行顺序 (附录)

```mermaid
graph TD
    Source[源代码] --> FE[Frontend Parse]
    FE --> AST[AST 构建]
    AST --> SymbolResolver[符号解析]
    SymbolResolver --> EOGPass[EvaluationOrderGraphPass]
    EOGPass --> DFGPass[DFGPass]
    DFGPass --> CFDG[ControlFlowSensitiveDFGPass]
    CFDG --> UnreachPass[UnreachableEOGPass]
    UnreachPass --> Done[图构建完成]

    style UnreachPass fill:#ff9999
    style Done fill:#99ff99
```

**用途**: 展示 CPG Pass 的执行顺序和依赖关系

---

## 图表复用指南

### 如何复用这些图表

1. **复制源码**: 直接复制对应图表的 Mermaid 代码
2. **调整样式**: 修改 `style` 命令改变颜色和形状
3. **添加节点**: 在相应位置添加新的节点和边
4. **导出图片**: 使用 Mermaid Live Editor 或 Marp CLI 导出为 SVG/PNG

### Mermaid 语法快速参考

```mermaid
# 流程图
flowchart TD
    A[矩形] --> B{菱形}
    B -->|是| C[结果1]
    B -->|否| D[结果2]

# 序列图
sequenceDiagram
    Alice->>Bob: 消息
    Bob-->>Alice: 响应

# 类图
graph TD
    Parent --> Child1
    Parent --> Child2
```

---

## 颜色方案

| 用途 | 颜色代码 | 示例 |
|------|---------|------|
| 可达节点 | `#99ff99` | 绿色 |
| 不可达节点 | `#cccccc` | 灰色 |
| 常量 | `#ccf5ff` | 蓝色 |
| AST 层 | `#e1f5ff` | 浅蓝 |
| EOG 层 | `#ffe1f5` | 粉色 |
| DFG 层 | `#f5ffe1` | 浅绿 |
| 求值层 | `#fff5e1` | 米色 |
| 警告/错误 | `#ff9999` | 红色 |

---

**所有图表源码可直接用于 Mermaid Live Editor (https://mermaid.live/) 预览和编辑**
