# 8.3 CPG å®¹å™¨åŒ–æ¶æ„ - ä½¿ç”¨æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-12
**ç›®æ ‡è¯»è€…**: æœ€ç»ˆç”¨æˆ·ã€è¿ç»´äººå‘˜ã€å®‰å…¨åˆ†æå¸ˆ
**æ–‡æ¡£ç›®æ ‡**: 5 åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹ï¼Œè§£å†³ 90% å¸¸è§é—®é¢˜

---

## ç›®å½•

1. [å¿«é€Ÿå¼€å§‹ï¼ˆ5 åˆ†é’Ÿï¼‰](#1-å¿«é€Ÿå¼€å§‹5-åˆ†é’Ÿ)
2. [æ„å»ºå®¹å™¨ä½¿ç”¨æŒ‡å—](#2-æ„å»ºå®¹å™¨ä½¿ç”¨æŒ‡å—)
3. [æŸ¥è¯¢å®¹å™¨ä½¿ç”¨æŒ‡å—](#3-æŸ¥è¯¢å®¹å™¨ä½¿ç”¨æŒ‡å—)
4. [ç¼–å†™æŸ¥è¯¢è„šæœ¬(.kts)](#4-ç¼–å†™æŸ¥è¯¢è„šæœ¬kts)
5. [å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#5-å¸¸è§é—®é¢˜faq)
6. [é«˜çº§ç”¨æ³•](#6-é«˜çº§ç”¨æ³•)
7. [æ•…éšœæ’æŸ¥](#7-æ•…éšœæ’æŸ¥)

---

## 1. å¿«é€Ÿå¼€å§‹ï¼ˆ5 åˆ†é’Ÿï¼‰

### 1.1 å‰ç½®æ¡ä»¶

**æ£€æŸ¥ç¯å¢ƒ**ï¼š
```bash
# éªŒè¯ Docker å’Œ Docker Compose å·²å®‰è£…
docker --version  # éœ€è¦ 24.0+
docker-compose --version  # éœ€è¦ 2.20+

# å¦‚æœæœªå®‰è£…ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.docker.com/get-docker/
```

---

### 1.2 ä¸‹è½½ç¤ºä¾‹ä»“åº“

```bash
# å…‹éš† CPG ä»“åº“ï¼ˆåŒ…å«å®¹å™¨é•œåƒå®šä¹‰ï¼‰
git clone https://github.com/Fraunhofer-AISEC/cpg.git
cd cpg/docker

# æˆ–è€…ç›´æ¥ä¸‹è½½ç¤ºä¾‹é…ç½®
wget https://raw.githubusercontent.com/Fraunhofer-AISEC/cpg/main/docker-compose.yml
wget https://raw.githubusercontent.com/Fraunhofer-AISEC/cpg/main/.env.example
mv .env.example .env
```

---

### 1.3 é…ç½®ç¯å¢ƒå˜é‡

**ç¼–è¾‘ `.env` æ–‡ä»¶**ï¼š
```bash
# æ„å»ºé…ç½®ï¼ˆå¿…éœ€ï¼‰
GIT_REPO=https://github.com/spring-projects/spring-petclinic.git  # ç¤ºä¾‹ï¼šSpring Pet Clinic
GIT_REF=main
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass
LANGUAGES=java

# æŸ¥è¯¢é…ç½®ï¼ˆå¯é€‰ï¼Œç¨åé…ç½®ï¼‰
QUERY_NAME=find-unreachable-code
```

---

### 1.4 å¯åŠ¨æ„å»ºå®¹å™¨

**æ­¥éª¤ 1: æ„å»ºå›¾**
```bash
# å¯åŠ¨æ„å»ºå®¹å™¨ï¼ˆä¸€æ¬¡æ€§è¿è¡Œï¼‰
docker-compose up builder

# è¾“å‡ºç¤ºä¾‹ï¼š
# ========================================
# CPG Build Container
# ========================================
# GIT_REPO: https://github.com/spring-projects/spring-petclinic.git
# GIT_REF: main
# PASSES: EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass
# LANGUAGES: java
# ========================================
# ğŸ“¥ Cloning repository...
# ğŸ”§ Building CPG graph...
# âœ… Build completed successfully!
#    - Graph: /output/graph.dump
#    - Config: /output/graph.dump.config.json
#    - Stats: /output/graph.dump.stats.json
```

**é¢„æœŸè€—æ—¶**ï¼š
- å°å‹é¡¹ç›®ï¼ˆ<10K LOCï¼‰ï¼š1-3 åˆ†é’Ÿ
- ä¸­å‹é¡¹ç›®ï¼ˆ30-50K LOCï¼‰ï¼š5-10 åˆ†é’Ÿ
- å¤§å‹é¡¹ç›®ï¼ˆ100K+ LOCï¼‰ï¼š10-20 åˆ†é’Ÿ

---

### 1.5 è¿è¡Œç¬¬ä¸€ä¸ªæŸ¥è¯¢

**æ­¥éª¤ 2: æ‰§è¡ŒæŸ¥è¯¢**
```bash
# æŸ¥çœ‹å¯ç”¨çš„æŸ¥è¯¢è„šæœ¬
ls queries/

# è¾“å‡ºï¼š
# find-unreachable-code.kts
# security-scan.kts
# code-quality-check.kts
# ...

# è¿è¡ŒæŸ¥è¯¢
docker-compose run query \
  -e QUERY_NAME=find-unreachable-code

# æˆ–ä½¿ç”¨ docker run
docker run --rm \
  -e GRAPH_PATH=/input/graph.dump \
  -e QUERY_SCRIPT=/queries/find-unreachable-code.kts \
  -v cpg-graph-data:/input:ro \
  -v $(pwd)/queries:/queries:ro \
  -v $(pwd)/results:/output \
  cpg-query:v1.0
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
========================================
CPG Query Container
========================================
GRAPH_PATH: /input/graph.dump
QUERY_SCRIPT: /queries/find-unreachable-code.kts
OUTPUT_PATH: /output/find-unreachable-code-result.json
========================================
ğŸ“¥ Loading graph from /input/graph.dump...
âœ… Graph loaded successfully
   - Nodes: 50000
   - EOG Edges: 180000
   - DFG Edges: 75000
ğŸ” Executing query script: /queries/find-unreachable-code.kts...
[QUERY] Found 1250 if statements
[QUERY] Found 38 unreachable branches
ğŸ“¤ Writing results to /output/find-unreachable-code-result.json...
âœ… Query completed successfully!
```

---

### 1.6 æŸ¥çœ‹æŸ¥è¯¢ç»“æœ

```bash
# æŸ¥çœ‹ç»“æœï¼ˆJSON æ ¼å¼ï¼‰
cat results/find-unreachable-code-result.json | jq .

# è¾“å‡ºç¤ºä¾‹ï¼š
{
  "totalIfStatements": 1250,
  "unreachableBranches": [
    {
      "file": "src/main/java/org/springframework/samples/petclinic/owner/OwnerController.java",
      "line": 45,
      "code": "if (true) { ... } else { /* è¿™é‡Œä¸å¯è¾¾ */ }"
    },
    // ... æ›´å¤šç»“æœ
  ]
}
```

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»å®Œæˆç¬¬ä¸€æ¬¡æ„å»ºå’ŒæŸ¥è¯¢ï¼**

**æ¥ä¸‹æ¥**ï¼š
- å°è¯•å…¶ä»–æŸ¥è¯¢è„šæœ¬ï¼ˆ`security-scan.kts`, `code-quality-check.kts`ï¼‰
- ç¼–å†™è‡ªå·±çš„æŸ¥è¯¢è„šæœ¬ï¼ˆå‚è§ [ç¬¬ 4 èŠ‚](#4-ç¼–å†™æŸ¥è¯¢è„šæœ¬kts)ï¼‰
- å¹¶å‘è¿è¡Œå¤šä¸ªæŸ¥è¯¢ï¼ˆ`docker-compose up --scale query=5 query`ï¼‰

---

## 2. æ„å»ºå®¹å™¨ä½¿ç”¨æŒ‡å—

### 2.1 ç¯å¢ƒå˜é‡é…ç½®è¯¦è§£

| ç¯å¢ƒå˜é‡ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|------|
| `GIT_REPO` | âœ… | Git ä»“åº“ URLï¼ˆæ”¯æŒ HTTPS å’Œ SSHï¼‰| `https://github.com/user/repo.git` |
| `GIT_REF` | âœ… | åˆ†æ”¯ã€æ ‡ç­¾æˆ– commit SHA | `main`, `v1.0.0`, `a1b2c3d4` |
| `PASSES` | âœ… | Pass åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œæ— ç©ºæ ¼ï¼‰| `EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass` |
| `LANGUAGES` | âœ… | è¯­è¨€å‰ç«¯åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰| `java,kotlin` |
| `OUTPUT_PATH` | âŒ | è¾“å‡ºæ–‡ä»¶è·¯å¾„ | `/output/graph.dump`ï¼ˆé»˜è®¤ï¼‰|
| `SOURCE_INCLUDES` | âŒ | æºç è·¯å¾„è¿‡æ»¤ï¼ˆåŒ…å«ï¼‰| `**/*.java,**/*.kt`ï¼ˆé»˜è®¤ï¼‰|
| `SOURCE_EXCLUDES` | âŒ | æºç è·¯å¾„è¿‡æ»¤ï¼ˆæ’é™¤ï¼‰| `**/test/**,**/generated/**`ï¼ˆé»˜è®¤ï¼‰|

---

### 2.2 å¸¸ç”¨ Pass é…ç½®

**åŸºç¡€åˆ†æ**ï¼ˆé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼‰ï¼š
```bash
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass
```

**é«˜çº§åˆ†æ**ï¼ˆåŒ…å«ä¸å¯è¾¾ä»£ç æ£€æµ‹ï¼‰ï¼š
```bash
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass
```

**å®Œæ•´åˆ†æ**ï¼ˆåŒ…å«æ§åˆ¶ä¾èµ–ã€è¿‡ç¨‹é—´æ•°æ®æµï¼‰ï¼š
```bash
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass,ControlDependenceGraphPass,DynamicInvokeResolver
```

**è‡ªå®šä¹‰ Pass**ï¼š
- æŸ¥çœ‹å¯ç”¨ Pass åˆ—è¡¨ï¼š`cpg-core/src/main/kotlin/de/fraunhofer/aisec/cpg/passes/`
- Pass é¡ºåºå¾ˆé‡è¦ï¼åé¢çš„ Pass å¯èƒ½ä¾èµ–å‰é¢çš„ Pass

---

### 2.3 ä½¿ç”¨ç§æœ‰ Git ä»“åº“

**æ–¹æ³• 1: ä½¿ç”¨ SSH å¯†é’¥**
```bash
# æŒ‚è½½ SSH å¯†é’¥
docker run --rm \
  -e GIT_REPO=git@github.com:user/private-repo.git \
  -v ~/.ssh:/root/.ssh:ro \
  -v $(pwd)/output:/output \
  cpg-builder:v1.0
```

**æ–¹æ³• 2: ä½¿ç”¨ Git å‡­è¯**
```bash
# ä½¿ç”¨ Git å‡­è¯ï¼ˆHTTPSï¼‰
docker run --rm \
  -e GIT_REPO=https://user:token@github.com/user/private-repo.git \
  -v $(pwd)/output:/output \
  cpg-builder:v1.0
```

---

### 2.4 æœ¬åœ°ä»£ç åˆ†æï¼ˆæ— éœ€ Gitï¼‰

```bash
# ç›´æ¥æŒ‚è½½æœ¬åœ°ä»£ç ç›®å½•
docker run --rm \
  -e SOURCE_PATH=/source \
  -e PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass \
  -e LANGUAGES=java \
  -v $(pwd)/my-project:/source:ro \
  -v $(pwd)/output:/output \
  cpg-builder:v1.0
```

---

### 2.5 æŸ¥çœ‹æ„å»ºç»Ÿè®¡ä¿¡æ¯

**æ„å»ºå®Œæˆåï¼ŒæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯**ï¼š
```bash
# æŸ¥çœ‹ stats.json
cat output/graph.dump.stats.json | jq .

# è¾“å‡ºç¤ºä¾‹ï¼š
{
  "nodeCount": 50000,
  "edgeCount": 255000,
  "eogEdgeCount": 180000,
  "dfgEdgeCount": 75000,
  "buildDurationSeconds": 180,
  "linesOfCode": 25000,
  "fileCount": 150
}
```

---

## 3. æŸ¥è¯¢å®¹å™¨ä½¿ç”¨æŒ‡å—

### 3.1 åŸºæœ¬æŸ¥è¯¢æ‰§è¡Œ

**æ–¹æ³• 1: ä½¿ç”¨ Docker Compose**
```bash
# 1. é…ç½®æŸ¥è¯¢åç§°
export QUERY_NAME=find-unreachable-code

# 2. è¿è¡ŒæŸ¥è¯¢
docker-compose run query

# 3. æŸ¥çœ‹ç»“æœ
cat results/$QUERY_NAME-result.json | jq .
```

**æ–¹æ³• 2: ä½¿ç”¨ docker run**
```bash
docker run --rm \
  -e GRAPH_PATH=/input/graph.dump \
  -e QUERY_SCRIPT=/queries/my-query.kts \
  -e OUTPUT_PATH=/output/my-result.json \
  -v cpg-graph-data:/input:ro \
  -v $(pwd)/queries:/queries:ro \
  -v $(pwd)/results:/output \
  cpg-query:v1.0
```

---

### 3.2 å¹¶å‘æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢

**åœºæ™¯**ï¼šåŒæ—¶è¿è¡Œå®‰å…¨æ‰«æã€è´¨é‡æ£€æŸ¥ã€è®¸å¯è¯åˆè§„æ£€æŸ¥

**æ–¹æ³• 1: Docker Compose å¹¶å‘**
```yaml
# docker-compose.yml
services:
  query-security:
    image: cpg-query:v1.0
    environment:
      - GRAPH_PATH=/input/graph.dump
      - QUERY_SCRIPT=/queries/security-scan.kts
      - OUTPUT_PATH=/output/security-result.json
    volumes:
      - graph-data:/input:ro
      - ./queries:/queries:ro
      - ./results:/output

  query-quality:
    image: cpg-query:v1.0
    environment:
      - GRAPH_PATH=/input/graph.dump
      - QUERY_SCRIPT=/queries/code-quality-check.kts
      - OUTPUT_PATH=/output/quality-result.json
    volumes:
      - graph-data:/input:ro
      - ./queries:/queries:ro
      - ./results:/output

  query-license:
    image: cpg-query:v1.0
    environment:
      - GRAPH_PATH=/input/graph.dump
      - QUERY_SCRIPT=/queries/license-check.kts
      - OUTPUT_PATH=/output/license-result.json
    volumes:
      - graph-data:/input:ro
      - ./queries:/queries:ro
      - ./results:/output
```

**å¯åŠ¨å¹¶å‘æŸ¥è¯¢**ï¼š
```bash
# å¹¶å‘è¿è¡Œ 3 ä¸ªæŸ¥è¯¢
docker-compose up query-security query-quality query-license
```

**æ–¹æ³• 2: å¹¶è¡Œ docker run**
```bash
# å¹¶è¡Œè¿è¡Œå¤šä¸ªæŸ¥è¯¢
docker run ... -e QUERY_SCRIPT=/queries/security-scan.kts &
docker run ... -e QUERY_SCRIPT=/queries/code-quality-check.kts &
docker run ... -e QUERY_SCRIPT=/queries/license-check.kts &

# ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
wait
```

---

### 3.3 é…ç½®æŸ¥è¯¢è¶…æ—¶å’Œå†…å­˜é™åˆ¶

**è®¾ç½®æŸ¥è¯¢è¶…æ—¶**ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰ï¼š
```bash
docker run --rm \
  -e QUERY_TIMEOUT=600 \  # 10 åˆ†é’Ÿ
  -e GRAPH_PATH=/input/graph.dump \
  -e QUERY_SCRIPT=/queries/complex-analysis.kts \
  -v cpg-graph-data:/input:ro \
  -v $(pwd)/queries:/queries:ro \
  cpg-query:v1.0
```

**è®¾ç½®å†…å­˜é™åˆ¶**ï¼ˆé˜²æ­¢ OOMï¼‰ï¼š
```bash
docker run --rm \
  --memory=4g \  # é™åˆ¶å†…å­˜ 4GB
  --memory-swap=4g \  # é™åˆ¶ swap 4GB
  -e GRAPH_PATH=/input/graph.dump \
  -e QUERY_SCRIPT=/queries/memory-intensive.kts \
  -v cpg-graph-data:/input:ro \
  -v $(pwd)/queries:/queries:ro \
  cpg-query:v1.0
```

---

## 4. ç¼–å†™æŸ¥è¯¢è„šæœ¬(.kts)

### 4.1 æŸ¥è¯¢è„šæœ¬åŸºç¡€

**æœ€å°ç¤ºä¾‹**ï¼ˆ`hello-query.kts`ï¼‰ï¼š
```kotlin
// æŸ¥è¯¢å®¹å™¨è‡ªåŠ¨æ³¨å…¥ä»¥ä¸‹å˜é‡ï¼š
// - val result: TranslationResult  // CPG å›¾
// - val config: TranslationConfiguration  // é…ç½®å…ƒæ•°æ®
// - fun output(data: Any)  // è¾“å‡ºç»“æœåˆ° JSON
// - fun log(message: String)  // æ‰“å°æ—¥å¿—

// æ‰“å°æ—¥å¿—
log("Hello from query script!")

// æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹
val allNodes = result.components.flatMap { it.allChildren<de.fraunhofer.aisec.cpg.graph.Node>() }
log("Total nodes: ${allNodes.size}")

// è¾“å‡ºç»“æœ
output(mapOf(
    "message" to "Hello, CPG!",
    "nodeCount" to allNodes.size
))
```

---

### 4.2 å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼

#### æ¨¡å¼ 1: æŸ¥æ‰¾ç‰¹å®šç±»å‹çš„èŠ‚ç‚¹

```kotlin
// æŸ¥æ‰¾æ‰€æœ‰ if è¯­å¥
import de.fraunhofer.aisec.cpg.graph.statements.IfStatement

val ifStatements = result.allNodes<IfStatement>()
log("Found ${ifStatements.size} if statements")

output(mapOf(
    "totalIfStatements" to ifStatements.size,
    "locations" to ifStatements.map {
        mapOf(
            "file" to it.location?.artifactLocation?.uri,
            "line" to it.location?.region?.startLine
        )
    }
))
```

---

#### æ¨¡å¼ 2: æŸ¥æ‰¾ä¸å¯è¾¾ä»£ç 

```kotlin
import de.fraunhofer.aisec.cpg.graph.statements.IfStatement
import de.fraunhofer.aisec.cpg.graph.edges.flows.EvaluationOrder

val unreachableBranches = result.allNodes<IfStatement>().filter { ifStmt ->
    ifStmt.nextEOGEdges.any { edge ->
        edge is EvaluationOrder && edge.unreachable == true
    }
}

log("Found ${unreachableBranches.size} unreachable branches")

output(mapOf(
    "unreachableBranches" to unreachableBranches.map {
        mapOf(
            "file" to it.location?.artifactLocation?.uri,
            "line" to it.location?.region?.startLine,
            "code" to it.code
        )
    }
))
```

---

#### æ¨¡å¼ 3: æ•°æ®æµåˆ†æ

```kotlin
import de.fraunhofer.aisec.cpg.graph.statements.expressions.CallExpression
import de.fraunhofer.aisec.cpg.graph.declarations.VariableDeclaration

// æŸ¥æ‰¾æ‰€æœ‰å±é™©å‡½æ•°è°ƒç”¨ï¼ˆå¦‚ exec, evalï¼‰
val dangerousCalls = result.allNodes<CallExpression>().filter {
    it.name.localName in listOf("exec", "eval", "Runtime.getRuntime", "ProcessBuilder")
}

// åˆ†ææ•°æ®æµï¼šå˜é‡æ˜¯å¦æ¥è‡ªç”¨æˆ·è¾“å…¥
val taintedCalls = dangerousCalls.filter { call ->
    call.arguments.any { arg ->
        // æ£€æŸ¥æ•°æ®æµæ˜¯å¦æ¥è‡ªç”¨æˆ·è¾“å…¥
        arg.prevDFG.any { dfgEdge ->
            dfgEdge.start is VariableDeclaration &&
            dfgEdge.start.name.localName.contains("request") // ç®€åŒ–ç¤ºä¾‹
        }
    }
}

log("Found ${taintedCalls.size} potentially dangerous calls with user input")

output(mapOf(
    "dangerousCalls" to taintedCalls.map {
        mapOf(
            "functionName" to it.name.localName,
            "file" to it.location?.artifactLocation?.uri,
            "line" to it.location?.region?.startLine,
            "arguments" to it.arguments.map { arg -> arg.code }
        )
    }
))
```

---

#### æ¨¡å¼ 4: å¤æ‚åº¦åˆ†æ

```kotlin
import de.fraunhofer.aisec.cpg.graph.declarations.FunctionDeclaration
import de.fraunhofer.aisec.cpg.graph.statements.IfStatement
import de.fraunhofer.aisec.cpg.graph.statements.ForStatement
import de.fraunhofer.aisec.cpg.graph.statements.WhileStatement

// è®¡ç®—æ¯ä¸ªå‡½æ•°çš„åœˆå¤æ‚åº¦
val functions = result.allNodes<FunctionDeclaration>()

val complexityReport = functions.map { func ->
    val ifCount = func.allChildren<IfStatement>().size
    val forCount = func.allChildren<ForStatement>().size
    val whileCount = func.allChildren<WhileStatement>().size

    val complexity = 1 + ifCount + forCount + whileCount

    mapOf(
        "functionName" to func.name.localName,
        "file" to func.location?.artifactLocation?.uri,
        "line" to func.location?.region?.startLine,
        "complexity" to complexity,
        "warning" to (complexity > 10)  // åœˆå¤æ‚åº¦ >10 è­¦å‘Š
    )
}

// è¿‡æ»¤é«˜å¤æ‚åº¦å‡½æ•°
val highComplexityFunctions = complexityReport.filter { it["complexity"] as Int > 10 }

log("Found ${highComplexityFunctions.size} functions with complexity > 10")

output(mapOf(
    "highComplexityFunctions" to highComplexityFunctions
))
```

---

### 4.3 æŸ¥è¯¢è„šæœ¬è°ƒè¯•

**æ–¹æ³• 1: ä½¿ç”¨ log() æ‰“å°è°ƒè¯•ä¿¡æ¯**
```kotlin
log("DEBUG: Starting analysis...")
val nodes = result.allNodes<IfStatement>()
log("DEBUG: Found ${nodes.size} if statements")
nodes.forEachIndexed { index, node ->
    log("DEBUG: [$index] ${node.code}")
}
```

**æ–¹æ³• 2: åœ¨ IntelliJ IDEA ä¸­ç¼–è¾‘ .kts**
```
1. åœ¨ IntelliJ ä¸­æ‰“å¼€ .kts æ–‡ä»¶
2. é…ç½® Kotlin SDKï¼ˆFile â†’ Project Structure â†’ SDKsï¼‰
3. è·å¾—ä»£ç è¡¥å…¨å’Œç±»å‹æ£€æŸ¥
4. ä½¿ç”¨ Run â†’ Run Script æœ¬åœ°æµ‹è¯•ï¼ˆéœ€è¦é¢„å…ˆåŠ è½½ CPG å›¾ï¼‰
```

---

### 4.4 æŸ¥è¯¢è„šæœ¬æœ€ä½³å®è·µ

**1. ä½¿ç”¨ç±»å‹å¯¼å…¥**ï¼ˆé¿å…é‡å¤å†™åŒ…åï¼‰ï¼š
```kotlin
import de.fraunhofer.aisec.cpg.graph.statements.IfStatement
import de.fraunhofer.aisec.cpg.graph.edges.flows.EvaluationOrder

val ifStatements = result.allNodes<IfStatement>()  // ç®€æ´
```

**2. æå‰è¿‡æ»¤èŠ‚ç‚¹**ï¼ˆæé«˜æ€§èƒ½ï¼‰ï¼š
```kotlin
// âŒ æ…¢ï¼šéå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ£€æŸ¥å¤šä¸ªæ¡ä»¶
val badApproach = result.components.flatMap { it.allChildren<Node>() }.filter {
    it is IfStatement && it.location?.artifactLocation?.uri?.contains("Controller") == true
}

// âœ… å¿«ï¼šå…ˆæŒ‰ç±»å‹è¿‡æ»¤ï¼Œå†æŒ‰å…¶ä»–æ¡ä»¶è¿‡æ»¤
val goodApproach = result.allNodes<IfStatement>().filter {
    it.location?.artifactLocation?.uri?.contains("Controller") == true
}
```

**3. é™åˆ¶è¾“å‡ºå¤§å°**ï¼ˆé¿å…ç”Ÿæˆ GB çº§ JSONï¼‰ï¼š
```kotlin
val results = dangerousCalls.map { ... }

// é™åˆ¶è¾“å‡ºå‰ 100 ä¸ªç»“æœ
output(mapOf(
    "total" to results.size,
    "topResults" to results.take(100),
    "warning" to if (results.size > 100) "Results truncated to 100" else null
))
```

---

## 5. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: æ„å»ºå®¹å™¨å¤±è´¥ï¼š"Failed to clone repository"

**ç—‡çŠ¶**ï¼š
```
âŒ Failed to clone repository
fatal: could not read Username for 'https://github.com': terminal prompts disabled
```

**åŸå› **ï¼šGit ä»“åº“æ˜¯ç§æœ‰çš„ï¼Œéœ€è¦è®¤è¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ³• 1: ä½¿ç”¨ Personal Access Token
export GIT_REPO="https://user:ghp_XXXXXXXXXXXXX@github.com/user/private-repo.git"

# æ–¹æ³• 2: ä½¿ç”¨ SSHï¼ˆæŒ‚è½½ SSH å¯†é’¥ï¼‰
docker run --rm \
  -e GIT_REPO=git@github.com:user/private-repo.git \
  -v ~/.ssh:/root/.ssh:ro \
  -v $(pwd)/output:/output \
  cpg-builder:v1.0
```

---

### Q2: æ„å»ºå®¹å™¨å¤±è´¥ï¼š"OutOfMemoryError: Java heap space"

**ç—‡çŠ¶**ï¼š
```
java.lang.OutOfMemoryError: Java heap space
```

**åŸå› **ï¼šé¡¹ç›®è¿‡å¤§ï¼Œé»˜è®¤å†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ  JVM å †å†…å­˜
docker run --rm \
  -e JAVA_OPTS="-Xmx8g -Xms4g" \
  -e GIT_REPO=... \
  -v $(pwd)/output:/output \
  cpg-builder:v1.0
```

---

### Q3: æŸ¥è¯¢å®¹å™¨å¤±è´¥ï¼š"ClassNotFoundException: de.fraunhofer.aisec.cpg.graph.Node"

**ç—‡çŠ¶**ï¼š
```
java.lang.ClassNotFoundException: de.fraunhofer.aisec.cpg.graph.Node
```

**åŸå› **ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä½¿ç”¨çš„ CPG ç‰ˆæœ¬ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥ config.json ä¸­çš„ç‰ˆæœ¬
cat output/graph.dump.config.json | jq .version

# 2. ç¡®ä¿æ„å»ºå®¹å™¨å’ŒæŸ¥è¯¢å®¹å™¨ä½¿ç”¨ç›¸åŒçš„ CPG ç‰ˆæœ¬
docker inspect cpg-builder:v1.0 | grep CPG_VERSION
docker inspect cpg-query:v1.0 | grep CPG_VERSION

# 3. å¦‚æœç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œé‡æ–°æ„å»ºé•œåƒ
docker build -t cpg-builder:v1.0 -f docker/build-container/Dockerfile .
docker build -t cpg-query:v1.0 -f docker/query-container/Dockerfile .
```

---

### Q4: æŸ¥è¯¢è„šæœ¬ç¼–è¯‘å¤±è´¥ï¼š"unresolved reference: TranslationResult"

**ç—‡çŠ¶**ï¼š
```
error: unresolved reference: TranslationResult
```

**åŸå› **ï¼šè„šæœ¬æ²¡æœ‰è‡ªåŠ¨ import CPG API

**è§£å†³æ–¹æ¡ˆ**ï¼š
```kotlin
// åœ¨è„šæœ¬å¼€å¤´æ‰‹åŠ¨ import
import de.fraunhofer.aisec.cpg.TranslationResult
import de.fraunhofer.aisec.cpg.graph.Node
import de.fraunhofer.aisec.cpg.graph.statements.IfStatement

// æˆ–è€…åœ¨ QueryRunner ä¸­é…ç½® defaultImportsï¼ˆå·²é»˜è®¤é…ç½®ï¼‰
```

---

### Q5: æŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œä½†é¢„æœŸåº”è¯¥æœ‰ç»“æœ

**åŸå›  1**: Pass æœªæ³¨å†Œ
```bash
# æ£€æŸ¥ config.json ä¸­çš„ registeredPasses
cat output/graph.dump.config.json | jq .registeredPasses

# å¦‚æœ UnreachableEOGPass ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œéœ€è¦é‡æ–°æ„å»ºå›¾
export PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass
docker-compose up builder
```

**åŸå›  2**: æŸ¥è¯¢é€»è¾‘é”™è¯¯
```kotlin
// è°ƒè¯•ï¼šæ‰“å°ä¸­é—´ç»“æœ
log("DEBUG: All if statements: ${result.allNodes<IfStatement>().size}")
log("DEBUG: Unreachable edges: ${result.allNodes<IfStatement>().flatMap { it.nextEOGEdges }.filterIsInstance<EvaluationOrder>().count { it.unreachable == true }}")
```

---

### Q6: å¦‚ä½•æŸ¥çœ‹æ„å»ºæˆ–æŸ¥è¯¢å®¹å™¨çš„æ—¥å¿—ï¼Ÿ

```bash
# æŸ¥çœ‹æ„å»ºå®¹å™¨æ—¥å¿—
docker-compose logs builder

# æŸ¥çœ‹æŸ¥è¯¢å®¹å™¨æ—¥å¿—
docker-compose logs query

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
docker-compose logs -f query

# æŸ¥çœ‹ç‰¹å®šå®¹å™¨çš„æ—¥å¿—
docker logs <container_id>
```

---

### Q7: å¦‚ä½•æ¸…ç†æ—§çš„å›¾æ•°æ®ï¼Ÿ

```bash
# åˆ é™¤æ—§çš„ graph.dump
rm output/graph.dump*

# æˆ–åˆ é™¤æ•´ä¸ª Docker volume
docker volume rm cpg-graph-data

# é‡æ–°æ„å»º
docker-compose up builder
```

---

## 6. é«˜çº§ç”¨æ³•

### 6.1 ä½¿ç”¨ Kubernetes éƒ¨ç½²

**éƒ¨ç½²æ„å»ºå®¹å™¨ï¼ˆJobï¼‰**ï¼š
```yaml
# build-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: cpg-builder
spec:
  template:
    spec:
      containers:
      - name: builder
        image: cpg-builder:v1.0
        env:
        - name: GIT_REPO
          value: "https://github.com/user/repo.git"
        - name: GIT_REF
          value: "main"
        - name: PASSES
          value: "EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass"
        - name: LANGUAGES
          value: "java"
        volumeMounts:
        - name: graph-storage
          mountPath: /output
      restartPolicy: Never
      volumes:
      - name: graph-storage
        persistentVolumeClaim:
          claimName: cpg-graph-pvc
```

**éƒ¨ç½²æŸ¥è¯¢å®¹å™¨ï¼ˆDeployment + HPAï¼‰**ï¼š
```yaml
# query-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cpg-query
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cpg-query
  template:
    metadata:
      labels:
        app: cpg-query
    spec:
      containers:
      - name: query
        image: cpg-query:v1.0
        env:
        - name: GRAPH_PATH
          value: "/input/graph.dump"
        - name: QUERY_SCRIPT
          value: "/queries/user-query.kts"
        volumeMounts:
        - name: graph-storage
          mountPath: /input
          readOnly: true
        - name: queries
          mountPath: /queries
          readOnly: true
        resources:
          limits:
            memory: "4Gi"
            cpu: "2000m"
      volumes:
      - name: graph-storage
        persistentVolumeClaim:
          claimName: cpg-graph-pvc
      - name: queries
        configMap:
          name: cpg-queries

---
# query-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cpg-query-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cpg-query
  minReplicas: 3
  maxReplicas: 100
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

---

### 6.2 é›†æˆåˆ° CI/CD æµç¨‹

**GitLab CI ç¤ºä¾‹**ï¼š
```yaml
# .gitlab-ci.yml
stages:
  - build-graph
  - security-scan
  - quality-check

build-cpg-graph:
  stage: build-graph
  image: cpg-builder:v1.0
  variables:
    GIT_REPO: $CI_REPOSITORY_URL
    GIT_REF: $CI_COMMIT_SHA
    PASSES: "EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass"
  script:
    - /app/entrypoint.sh
  artifacts:
    paths:
      - output/graph.dump*
    expire_in: 1 week

security-scan:
  stage: security-scan
  image: cpg-query:v1.0
  dependencies:
    - build-cpg-graph
  script:
    - export GRAPH_PATH=output/graph.dump
    - export QUERY_SCRIPT=/queries/security-scan.kts
    - java -jar /app/cpg-query.jar
  artifacts:
    reports:
      security: results/security-result.json

quality-check:
  stage: quality-check
  image: cpg-query:v1.0
  dependencies:
    - build-cpg-graph
  script:
    - export GRAPH_PATH=output/graph.dump
    - export QUERY_SCRIPT=/queries/code-quality-check.kts
    - java -jar /app/cpg-query.jar
  artifacts:
    reports:
      codequality: results/quality-result.json
```

---

### 6.3 ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆS3/OSSï¼‰æŒä¹…åŒ–å›¾

**ä¸Šä¼ åˆ° S3**ï¼š
```bash
# 1. æ„å»ºå›¾
docker-compose up builder

# 2. ä¸Šä¼ åˆ° S3
aws s3 cp output/graph.dump s3://cpg-graphs/$CI_COMMIT_SHA/graph.dump
aws s3 cp output/graph.dump.config.json s3://cpg-graphs/$CI_COMMIT_SHA/config.json
aws s3 cp output/graph.dump.stats.json s3://cpg-graphs/$CI_COMMIT_SHA/stats.json

# 3. æŸ¥è¯¢æ—¶ä¸‹è½½
aws s3 cp s3://cpg-graphs/$CI_COMMIT_SHA/graph.dump ./graph.dump
docker-compose run query
```

---

## 7. æ•…éšœæ’æŸ¥

### 7.1 æ„å»ºå®¹å™¨æ•…éšœæ’æŸ¥

**æ­¥éª¤ 1: æ£€æŸ¥ç¯å¢ƒå˜é‡**
```bash
docker-compose config
# è¾“å‡ºå½“å‰é…ç½®ï¼ŒéªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®
```

**æ­¥éª¤ 2: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
```bash
docker-compose logs --tail=100 builder
```

**æ­¥éª¤ 3: è¿›å…¥å®¹å™¨è°ƒè¯•**
```bash
# å¯åŠ¨å®¹å™¨ä½†ä¸æ‰§è¡Œ entrypoint
docker run --rm -it \
  -e GIT_REPO=... \
  --entrypoint /bin/bash \
  cpg-builder:v1.0

# æ‰‹åŠ¨æ‰§è¡Œæ­¥éª¤
git clone $GIT_REPO /tmp/repo
java -jar /app/cpg-core.jar --source /tmp/repo ...
```

---

### 7.2 æŸ¥è¯¢å®¹å™¨æ•…éšœæ’æŸ¥

**æ­¥éª¤ 1: éªŒè¯å›¾æ–‡ä»¶å­˜åœ¨**
```bash
docker run --rm \
  -v cpg-graph-data:/input \
  alpine ls -lh /input

# è¾“å‡ºç¤ºä¾‹ï¼š
# -rw-r--r-- 1 root root 45M Nov 12 10:30 graph.dump
# -rw-r--r-- 1 root root 1.2K Nov 12 10:30 graph.dump.config.json
# -rw-r--r-- 1 root root 512 Nov 12 10:30 graph.dump.stats.json
```

**æ­¥éª¤ 2: æµ‹è¯•è„šæœ¬è¯­æ³•**
```bash
# ä½¿ç”¨ kotlinc æ£€æŸ¥è„šæœ¬è¯­æ³•
kotlinc -script queries/my-query.kts
```

**æ­¥éª¤ 3: è¿›å…¥å®¹å™¨è°ƒè¯•**
```bash
docker run --rm -it \
  -v cpg-graph-data:/input \
  -v $(pwd)/queries:/queries \
  --entrypoint /bin/bash \
  cpg-query:v1.0

# æ‰‹åŠ¨æ‰§è¡Œ
java -jar /app/cpg-query.jar
```

---

### 7.3 æ€§èƒ½é—®é¢˜æ’æŸ¥

**é—®é¢˜ï¼šæŸ¥è¯¢å¾ˆæ…¢**

**è§£å†³æ–¹æ¡ˆ 1: åˆ†æç“¶é¢ˆ**
```kotlin
// åœ¨æŸ¥è¯¢è„šæœ¬ä¸­æ·»åŠ æ€§èƒ½åˆ†æ
import kotlin.system.measureTimeMillis

val time1 = measureTimeMillis {
    val ifStatements = result.allNodes<IfStatement>()
    log("Step 1: Found ${ifStatements.size} if statements")
}
log("Step 1 took $time1 ms")

val time2 = measureTimeMillis {
    val unreachable = ifStatements.filter { ... }
    log("Step 2: Filtered to ${unreachable.size} unreachable")
}
log("Step 2 took $time2 ms")
```

**è§£å†³æ–¹æ¡ˆ 2: ä¼˜åŒ–æŸ¥è¯¢é€»è¾‘**
```kotlin
// âŒ æ…¢ï¼šå¤šæ¬¡éå†å›¾
val allNodes = result.components.flatMap { it.allChildren<Node>() }
val ifStatements = allNodes.filterIsInstance<IfStatement>()
val forStatements = allNodes.filterIsInstance<ForStatement>()

// âœ… å¿«ï¼šä¸€æ¬¡éå†ï¼Œåˆ†ç±»
val (ifStatements, forStatements) = allNodes.partition { it is IfStatement }
```

---

**ğŸ‰ å®Œæˆï¼ä½ ç°åœ¨å·²ç»æŒæ¡äº† CPG å®¹å™¨åŒ–æ¶æ„çš„æ ¸å¿ƒç”¨æ³•ï¼**

**ä¸‹ä¸€æ­¥**ï¼š
- **æ·±å…¥å­¦ä¹ **: é˜…è¯» `8.4-å‚è€ƒ-APIæ–‡æ¡£.md` äº†è§£å®Œæ•´ API
- **é«˜çº§æŸ¥è¯¢**: å‚è€ƒ `/queries/advanced/` ç›®å½•ä¸­çš„é«˜çº§æŸ¥è¯¢ç¤ºä¾‹
- **ç”Ÿäº§éƒ¨ç½²**: é˜…è¯» Kubernetes éƒ¨ç½²æŒ‡å—ï¼ˆ`docs/deployment-k8s.md`ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-11-12
**åé¦ˆ**: å¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—® https://github.com/Fraunhofer-AISEC/cpg/issues
