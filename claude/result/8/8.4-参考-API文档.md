# 8.4 CPG 容器化架构 - API 参考文档

**文档版本**: 1.0
**创建日期**: 2025-11-12
**目标读者**: 开发者、集成者
**文档目标**: 快速查找 API、环境变量、配置选项

---

## 目录

1. [序列化 API](#1-序列化-api)
2. [反序列化 API](#2-反序列化-api)
3. [查询脚本 API](#3-查询脚本-api)
4. [环境变量参考](#4-环境变量参考)
5. [文件格式规范](#5-文件格式规范)
6. [配置选项参考](#6-配置选项参考)
7. [错误代码参考](#7-错误代码参考)

---

## 1. 序列化 API

### 1.1 TranslationResult.serialize()

**功能**：将 CPG 图序列化到文件

**签名**：
```kotlin
fun TranslationResult.serialize(path: String)
```

**参数**：
| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| `path` | `String` | ✅ | 输出文件路径（绝对路径或相对路径）|

**输出**：
- `<path>`: 序列化的图（二进制文件）
- `<path>.config.json`: 配置元数据（JSON 文件）
- `<path>.stats.json`: 统计信息（JSON 文件）

**异常**：
| 异常类型 | 触发条件 |
|---------|---------|
| `SerializationException` | 序列化失败（文件写入错误、权限不足、磁盘空间不足）|
| `IOException` | 文件 I/O 错误 |

**示例**：
```kotlin
import de.fraunhofer.aisec.cpg.TranslationManager
import de.fraunhofer.aisec.cpg.persistence.serialize

// 构建图
val result = TranslationManager.builder()
    .config { ... }
    .build()
    .analyze()

// 序列化
result.serialize("/output/graph.dump")
```

**输出示例**：
```
/output/graph.dump (45.2 MB)
/output/graph.dump.config.json (1.2 KB)
/output/graph.dump.stats.json (512 bytes)
```

---

## 2. 反序列化 API

### 2.1 TranslationResult.deserialize()

**功能**：从文件反序列化 CPG 图

**签名**：
```kotlin
fun TranslationResult.Companion.deserialize(
    path: String,
    validateConfig: Boolean = true
): TranslationResult
```

**参数**：
| 参数名 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `path` | `String` | ✅ | - | 输入文件路径（绝对路径或相对路径）|
| `validateConfig` | `Boolean` | ❌ | `true` | 是否验证 Pass 配置完整性 |

**返回值**：
| 类型 | 说明 |
|------|------|
| `TranslationResult` | 反序列化后的 CPG 图 |

**异常**：
| 异常类型 | 触发条件 |
|---------|---------|
| `DeserializationException` | 反序列化失败（文件损坏、格式不兼容）|
| `FileNotFoundException` | 文件不存在 |
| `IOException` | 文件 I/O 错误 |
| `MissingPassException` | Pass 配置验证失败（`validateConfig=true` 时）|

**示例**：
```kotlin
import de.fraunhofer.aisec.cpg.TranslationResult
import de.fraunhofer.aisec.cpg.persistence.deserialize

// 反序列化
val result = TranslationResult.deserialize("/input/graph.dump")

// 使用图
val ifStatements = result.allNodes<IfStatement>()
println("Total if statements: ${ifStatements.size}")
```

---

### 2.2 Pass 配置验证

**功能**：验证查询所需的 Pass 是否已注册

**触发条件**：`validateConfig=true`（默认）

**验证规则**：
- 检查 `config.json` 中的 `registeredPasses` 列表
- 如果查询使用 `FilterUnreachableEOG` 但 `UnreachableEOGPass` 未注册，抛出 `MissingPassException`

**示例**：
```kotlin
// 如果 config.json 中 registeredPasses = ["EvaluationOrderGraphPass"]
// 但查询使用 FilterUnreachableEOG
val result = TranslationResult.deserialize("/input/graph.dump", validateConfig = true)

// 抛出异常：
// MissingPassException: FilterUnreachableEOG requires UnreachableEOGPass,
// but it was not registered during build.
// Registered passes: [EvaluationOrderGraphPass]
```

---

## 3. 查询脚本 API

### 3.1 注入变量

查询容器自动注入以下变量到 .kts 脚本：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `result` | `TranslationResult` | 反序列化的 CPG 图 |
| `config` | `TranslationConfiguration` | 图的构建配置 |
| `output` | `(data: Any) -> Unit` | 输出结果到 JSON |
| `log` | `(message: String) -> Unit` | 打印日志到 stdout |

---

### 3.2 output() 函数

**功能**：输出查询结果到 JSON

**签名**：
```kotlin
fun output(data: Any)
```

**参数**：
| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| `data` | `Any` | ✅ | 要输出的数据（将被序列化为 JSON）|

**支持的类型**：
- 基本类型：`Int`, `String`, `Boolean`, `Double`
- 集合类型：`List<*>`, `Set<*>`, `Map<String, *>`
- 自定义对象：需实现序列化逻辑

**示例**：
```kotlin
// 输出简单数据
output(mapOf(
    "totalNodes" to 50000,
    "language" to "java"
))

// 输出复杂数据
output(mapOf(
    "results" to listOf(
        mapOf("file" to "Foo.java", "line" to 42),
        mapOf("file" to "Bar.java", "line" to 100)
    )
))
```

**输出格式**（`result.json`）：
```json
[
  {
    "totalNodes": 50000,
    "language": "java"
  },
  {
    "results": [
      {"file": "Foo.java", "line": 42},
      {"file": "Bar.java", "line": 100}
    ]
  }
]
```

---

### 3.3 log() 函数

**功能**：打印调试日志到 stdout

**签名**：
```kotlin
fun log(message: String)
```

**参数**：
| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| `message` | `String` | ✅ | 日志消息 |

**示例**：
```kotlin
log("Starting analysis...")
val nodes = result.allNodes<IfStatement>()
log("Found ${nodes.size} if statements")
```

**输出**（stdout）：
```
[QUERY] Starting analysis...
[QUERY] Found 1250 if statements
```

---

### 3.4 result 对象

**类型**：`TranslationResult`

**常用方法**：
| 方法 | 签名 | 说明 |
|------|------|------|
| `allNodes<T>()` | `inline fun <reified T : Node> TranslationResult.allNodes(): List<T>` | 查找所有类型为 T 的节点 |
| `components` | `val components: List<Component>` | 所有 Component 列表 |
| `config` | `val config: TranslationConfiguration` | 图的构建配置 |

**示例**：
```kotlin
import de.fraunhofer.aisec.cpg.graph.statements.IfStatement

// 查找所有 if 语句
val ifStatements = result.allNodes<IfStatement>()

// 遍历所有 Component
result.components.forEach { component ->
    println("Component: ${component.name}")
}

// 检查 Pass 配置
val passes = result.config.registeredPasses
println("Registered passes: $passes")
```

---

### 3.5 config 对象

**类型**：`TranslationConfiguration`

**常用属性**：
| 属性 | 类型 | 说明 |
|------|------|------|
| `registeredPasses` | `List<List<KClass<out Pass<*>>>>` | 已注册的 Pass 列表 |
| `languages` | `List<String>` | 语言前端列表 |
| `softwareComponents` | `List<SoftwareComponent>` | 软件组件配置 |

**示例**：
```kotlin
// 检查是否注册了 UnreachableEOGPass
val hasUnreachablePass = result.config.registeredPasses.flatten().any {
    it.simpleName == "UnreachableEOGPass"
}

if (!hasUnreachablePass) {
    log("Warning: UnreachableEOGPass not registered")
}
```

---

## 4. 环境变量参考

### 4.1 构建容器环境变量

| 变量名 | 必需 | 默认值 | 说明 | 示例 |
|--------|------|--------|------|------|
| `GIT_REPO` | ✅ | - | Git 仓库 URL | `https://github.com/user/repo.git` |
| `GIT_REF` | ✅ | `main` | 分支、标签或 commit SHA | `main`, `v1.0.0`, `a1b2c3d4` |
| `PASSES` | ✅ | - | Pass 列表（逗号分隔，无空格）| `EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass` |
| `LANGUAGES` | ✅ | `java` | 语言前端列表（逗号分隔）| `java,kotlin` |
| `OUTPUT_PATH` | ❌ | `/output/graph.dump` | 输出文件路径 | `/output/my-graph.dump` |
| `SOURCE_INCLUDES` | ❌ | `**/*.java,**/*.kt` | 源码路径过滤（包含）| `src/main/**/*.java` |
| `SOURCE_EXCLUDES` | ❌ | `**/test/**,**/generated/**` | 源码路径过滤（排除）| `**/build/**` |
| `JAVA_OPTS` | ❌ | `-Xmx4g -Xms2g` | JVM 堆内存配置 | `-Xmx8g -Xms4g` |

---

### 4.2 查询容器环境变量

| 变量名 | 必需 | 默认值 | 说明 | 示例 |
|--------|------|--------|------|------|
| `GRAPH_PATH` | ✅ | - | 图文件路径（绝对路径）| `/input/graph.dump` |
| `QUERY_SCRIPT` | ✅ | - | 查询脚本路径（.kts 文件）| `/queries/find-unreachable-code.kts` |
| `OUTPUT_PATH` | ❌ | `/output/result.json` | 查询结果输出路径 | `/output/my-result.json` |
| `QUERY_TIMEOUT` | ❌ | `300` | 查询超时（秒）| `600`（10 分钟）|
| `MAX_MEMORY` | ❌ | `4096` | 最大内存限制（MB）| `8192`（8 GB）|

---

### 4.3 环境变量示例配置

**构建容器**（`.env` 文件）：
```bash
# Git 配置
GIT_REPO=https://github.com/spring-projects/spring-petclinic.git
GIT_REF=main

# Pass 配置
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass

# 语言前端
LANGUAGES=java

# 可选：输出路径
OUTPUT_PATH=/output/spring-petclinic.dump

# 可选：源码过滤
SOURCE_INCLUDES=src/main/**/*.java
SOURCE_EXCLUDES=**/test/**,**/build/**

# 可选：JVM 内存
JAVA_OPTS=-Xmx8g -Xms4g
```

**查询容器**（`.env` 文件）：
```bash
# 图路径
GRAPH_PATH=/input/graph.dump

# 查询脚本
QUERY_SCRIPT=/queries/security-scan.kts

# 可选：输出路径
OUTPUT_PATH=/output/security-result.json

# 可选：超时和内存
QUERY_TIMEOUT=600
MAX_MEMORY=8192
```

---

## 5. 文件格式规范

### 5.1 graph.dump

**格式**：紧凑的二进制格式（非人类可读）

**编码**：
- 序列化库：Kryo（或 FST，取决于 Phase 1 Step 1 选型）
- 压缩：可选（Deflate/LZ4）

**内容**：
- 所有节点（`Node`）及其属性
- 所有边（`EOG`, `DFG`, `CDG`, `PDG`, `Invoke`, ...）及其属性
- 节点引用关系（处理循环引用）

**大小估算**：
| 项目规模 | LOC | 节点数 | 文件大小 |
|---------|-----|--------|---------|
| 小型 | <10K | <10K | ~10-20 MB |
| 中型 | 30-50K | 30-50K | ~50-100 MB |
| 大型 | 100K+ | 100K+ | ~200-500 MB |

---

### 5.2 config.json

**格式**：JSON（人类可读）

**字段规范**：
```json
{
  "version": "string",                   // CPG 版本
  "registeredPasses": [                  // Pass 列表（二维数组）
    ["EvaluationOrderGraphPass"],        // Pass Group 1
    ["ControlFlowSensitiveDFGPass"],     // Pass Group 2
    ["UnreachableEOGPass"]               // Pass Group 3
  ],
  "languages": ["string"],               // 语言前端列表
  "buildTimestamp": "ISO8601 timestamp", // 构建时间戳
  "gitInfo": {
    "repo": "string",                    // Git 仓库 URL
    "ref": "string",                     // 分支/标签/commit
    "commit": "string"                   // Commit SHA
  }
}
```

**示例**：
```json
{
  "version": "cpg-8.2.0",
  "registeredPasses": [
    ["EvaluationOrderGraphPass"],
    ["ControlFlowSensitiveDFGPass"],
    ["UnreachableEOGPass"]
  ],
  "languages": ["java", "kotlin"],
  "buildTimestamp": "2025-11-12T10:30:00Z",
  "gitInfo": {
    "repo": "https://github.com/spring-projects/spring-petclinic.git",
    "ref": "main",
    "commit": "a1b2c3d4e5f6"
  }
}
```

---

### 5.3 stats.json

**格式**：JSON（人类可读）

**字段规范**：
```json
{
  "nodeCount": "integer",            // 节点总数
  "edgeCount": "integer",            // 边总数
  "eogEdgeCount": "integer",         // EOG 边数
  "dfgEdgeCount": "integer",         // DFG 边数
  "buildDurationSeconds": "integer", // 构建耗时（秒）
  "linesOfCode": "integer",          // 代码行数
  "fileCount": "integer",            // 文件数
  "memoryUsedMB": "integer"          // 内存使用（MB）
}
```

**示例**：
```json
{
  "nodeCount": 50000,
  "edgeCount": 255000,
  "eogEdgeCount": 180000,
  "dfgEdgeCount": 75000,
  "buildDurationSeconds": 180,
  "linesOfCode": 25000,
  "fileCount": 150,
  "memoryUsedMB": 2048
}
```

---

### 5.4 查询结果（result.json）

**格式**：JSON（人类可读）

**结构**：数组（支持多次 `output()` 调用）

**示例**：
```json
[
  {
    "totalIfStatements": 1250,
    "unreachableBranches": [
      {
        "file": "src/main/java/com/example/Foo.java",
        "line": 42,
        "code": "if (true) { ... } else { /* unreachable */ }"
      },
      {
        "file": "src/main/java/com/example/Bar.java",
        "line": 100,
        "code": "if (false) { /* unreachable */ } else { ... }"
      }
    ]
  }
]
```

---

## 6. 配置选项参考

### 6.1 Pass 配置

**可用 Pass 列表**（常用）：
| Pass 名称 | 功能 | 依赖 | 推荐使用 |
|----------|------|------|---------|
| `EvaluationOrderGraphPass` | 构建 EOG（执行顺序图）| - | ✅ 基础分析必需 |
| `ControlFlowSensitiveDFGPass` | 构建 DFG（数据流图）| `EvaluationOrderGraphPass` | ✅ 数据流分析必需 |
| `UnreachableEOGPass` | 标记不可达代码 | `EvaluationOrderGraphPass` | ✅ 不可达代码检测 |
| `ControlDependenceGraphPass` | 构建 CDG（控制依赖图）| `EvaluationOrderGraphPass` | ❌ 高级分析可选 |
| `DynamicInvokeResolver` | 解析动态调用 | `EvaluationOrderGraphPass` | ❌ 反射分析可选 |

**Pass 顺序规则**：
- `EvaluationOrderGraphPass` 必须第一个（基础）
- `ControlFlowSensitiveDFGPass` 必须在 `EvaluationOrderGraphPass` 之后
- `UnreachableEOGPass` 必须在 `EvaluationOrderGraphPass` 之后

**推荐配置**：
```bash
# 基础分析
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass

# 高级分析（包含不可达代码检测）
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass

# 完整分析（包含控制依赖和动态调用）
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass,ControlDependenceGraphPass,DynamicInvokeResolver
```

---

### 6.2 语言前端配置

**可用语言前端**：
| 语言 | Frontend 类 | 配置值 |
|------|------------|--------|
| Java | `de.fraunhofer.aisec.cpg.frontends.java.JavaLanguage` | `java` |
| Kotlin | `de.fraunhofer.aisec.cpg.frontends.kotlin.KotlinLanguage` | `kotlin` |
| C/C++ | `de.fraunhofer.aisec.cpg.frontends.cxx.CLanguage` | `c,cpp` |
| Python | `de.fraunhofer.aisec.cpg.frontends.python.PythonLanguage` | `python` |
| TypeScript | `de.fraunhofer.aisec.cpg.frontends.typescript.TypeScriptLanguage` | `typescript` |

**配置示例**：
```bash
# 单语言
LANGUAGES=java

# 多语言（逗号分隔）
LANGUAGES=java,kotlin

# C/C++ 项目
LANGUAGES=c,cpp
```

---

### 6.3 源码过滤配置

**SOURCE_INCLUDES**（包含）：
- 支持 glob 模式：`**/*.java`, `src/main/**/*.kt`
- 逗号分隔：`**/*.java,**/*.kt`

**SOURCE_EXCLUDES**（排除）：
- 支持 glob 模式：`**/test/**`, `**/build/**`
- 逗号分隔：`**/test/**,**/generated/**,**/build/**`

**示例**：
```bash
# 只分析 src/main 目录的 Java 文件
SOURCE_INCLUDES=src/main/**/*.java
SOURCE_EXCLUDES=**/test/**,**/build/**

# 分析所有 Java 和 Kotlin 文件，排除测试和生成代码
SOURCE_INCLUDES=**/*.java,**/*.kt
SOURCE_EXCLUDES=**/test/**,**/generated/**
```

---

## 7. 错误代码参考

### 7.1 构建容器错误代码

| 错误代码 | 说明 | 解决方案 |
|---------|------|---------|
| `BUILD_ERR_001` | Git 仓库克隆失败 | 检查 `GIT_REPO` URL 是否正确，网络是否可达 |
| `BUILD_ERR_002` | Git 分支/commit 不存在 | 检查 `GIT_REF` 是否正确 |
| `BUILD_ERR_003` | Pass 配置错误 | 检查 `PASSES` 列表，确保 Pass 顺序正确 |
| `BUILD_ERR_004` | 内存不足（OOM）| 增加 `JAVA_OPTS=-Xmx8g` |
| `BUILD_ERR_005` | 序列化失败 | 检查磁盘空间，增加内存限制 |

---

### 7.2 查询容器错误代码

| 错误代码 | 说明 | 解决方案 |
|---------|------|---------|
| `QUERY_ERR_001` | 图文件不存在 | 检查 `GRAPH_PATH` 是否正确 |
| `QUERY_ERR_002` | 反序列化失败 | 检查构建容器和查询容器 CPG 版本是否一致 |
| `QUERY_ERR_003` | Pass 配置验证失败 | 检查 `config.json` 中的 `registeredPasses` 列表 |
| `QUERY_ERR_004` | 脚本编译失败 | 检查 `.kts` 脚本语法，使用 `kotlinc -script` 验证 |
| `QUERY_ERR_005` | 查询超时 | 增加 `QUERY_TIMEOUT`，优化查询逻辑 |
| `QUERY_ERR_006` | 内存不足（OOM）| 增加 Docker 内存限制 `--memory=8g` |

---

### 7.3 错误示例和解决方案

#### 错误 1: BUILD_ERR_003 - Pass 配置错误

**错误信息**：
```
❌ Error: Pass 'ControlFlowSensitiveDFGPass' requires 'EvaluationOrderGraphPass' to be registered first
```

**原因**：Pass 顺序错误

**解决方案**：
```bash
# ❌ 错误顺序
PASSES=ControlFlowSensitiveDFGPass,EvaluationOrderGraphPass

# ✅ 正确顺序
PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass
```

---

#### 错误 2: QUERY_ERR_003 - Pass 配置验证失败

**错误信息**：
```
❌ MissingPassException: FilterUnreachableEOG requires UnreachableEOGPass,
but it was not registered during build.
Registered passes: [EvaluationOrderGraphPass, ControlFlowSensitiveDFGPass]
```

**原因**：查询使用 `FilterUnreachableEOG`，但构建时未注册 `UnreachableEOGPass`

**解决方案**：
```bash
# 重新构建图，添加 UnreachableEOGPass
export PASSES=EvaluationOrderGraphPass,ControlFlowSensitiveDFGPass,UnreachableEOGPass
docker-compose up builder
```

---

**文档完成！**

**相关文档**：
- **8.1-架构-容器化设计.md**：架构设计和技术原理
- **8.2-实现-分步指南.md**：详细实施步骤
- **8.3-手册-使用指南.md**：快速开始和常见问题

**反馈**：
- GitHub Issues: https://github.com/Fraunhofer-AISEC/cpg/issues
- 文档更新: 欢迎提交 PR

---

**文档版本**: 1.0
**最后更新**: 2025-11-12
